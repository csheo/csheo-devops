# 🚀 db/migration

이 폴더는 우리의 Flyway 스크립트들이 모여 있는 곳이에요! 📚

## 스크립트 작성 규칙

> ⚠️ **해당 규칙을 항상 준수해주세요** ⚠️<br> 
> 규칙에서 어긋나는 일이 발생할 경우,
> - [X] 팀원들과 논의해주세요.📢
> - [X] 논의 후 예외를 적용 혹은, 규칙을 수정해주세요.🖋️

### **코멘트는 필수⭐**
각 스크립트에는 목적과 기능을 설명하는 코멘트를 꼭 추가해주세요. 📝

### **컬럼 순서 주의⚠️**
새로운 컬럼을 추가할 때는 시스템 컬럼 뒤에 추가하지 않도록 해요. 모든 개발이 그렇지만 귀찮다고 대충하면 나중에 더 힘들어진답니다(높은 확률로 내가 아닌 남이).🛠️

### **인코딩 설정 금지🚫**
아래의 경우를 제외하고 인코딩 설정은 DB의 기본값을 사용하도록 해요. 이렇게 하면 형변환(`CAST()`)에서 발생할 수 있는 에러를 예방할 수 있답니다. 🚫🔧
- ASCII 문자만 포함하는 컬럼의 콜레이션: `latin1_general_ci`
  - 물리 저장 방식을 최적화하기 위해 별도 콜레이션 지정
  - CHAR 및 VARCHAR 타입의 “코드”, “ID” 컬럼 등에서 사용

### **외래키 설정 필수⭐**
나중에 한다는 거짓말은 그만~ 외래키 설정은 바로 해주세요.<br> 
외래키를 제외하고 개발해야하는 상황에서는,
- [X] 한 번에 너무 많이 개발하는 것은 아닌지 체크해주세요. 🙏🔑
- [X] `SET FOREIGN_KEY_CHECKS=0;` 을 사용해주세요. 🙏🔑

### **버전 관리🔖**
각 스크립트 파일명에는 버전 번호를 명시해 주세요. 형식은 `V{release_version}_{sequence}__{description}`입니다. 이렇게 하면 변경 사항을 쉽게 추적할 수 있어요. 🕵️‍♂️🔖

### **DML 금지🚫**
가능한 DML은 스크립트에서 금지해주세요. DML이 들어가게 되면 자동 증가 숫자 값으로 인한 오류가 일어날 확률이 높고, 스크립트가 과도하게 드러나게 됩니다. DML은 개발 중에만 사용하고, 배포 시에는 사용하지 않아요. 테스트 데이터는 test 모듈에서 문서화 코드에 포함시키거나, 테스트 데이터 생성 메서드를 구현해주세요.🚫🔧
- 자세한 이유
  - 관리 복잡도 증가: 예를 들어 스크립트를 완전히 보존해야 한다면 상관 없는 시나리오 입니다만, 많아지면 가독성을 위해 모두 지우기도 합니다. 이때 DML이 껴있다면 DML 스크립트를 선별하는 작업을  해야합니다.
  - 롤백 용이성: Flyway의 경우 한 개의 스크립트가 실패 했을 경우 실패 지점 이전의 스크립트는 실행이 된 상태입니다(트랜잭션 롤백이 적용되지 않습니다).DDL의 경우 상대적으로 롤백이 쉬운 편입니다. DML 롤백은 자동증가값이나 외래키로 인해 롤백 난이도가 있습니다.
  - 환경간 데이터 일관성: 예를 들어 주문과 주문 상품 등 주문 관련 테이블들의 테스트 데이터를 로컬 것을 그대로 개발에 넣는 경우가 있었는데요. 자동 증가값 충돌로 인해 배포 과정에서 에러가 생기는 문제가 있었습니다.

### **테스트 주석🧹**
개발 중 테스트를 위해 사용한 주석은 반드시 제거해 주세요. 깨끗하고 명확한 코드 유지가 중요해요. 🧹✅

### **실행 계획 공유📢**
스크립트 실행 전, 실행 계획을 팀원들과 공유하고 동의를 얻으세요. 이는 예상치 못한 문제를 사전에 방지하는 데 도움이 됩니다.📢👥 

